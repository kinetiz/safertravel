{% extends "app/layout.html" %}

{% block content %}
    <style>
        .c3-region.regionX {
          fill: yellowgreen;
        }
        .c3-axis-y .tick {
            font-size: 14px;
            font-family: Calibri;
        }
        .c3-axis-y-label {
            font-size: 14px;
            font-family: Calibri;
            font-weight: bold;
        }
        .c3-axis-x .tick {
            font-size: 12px;
            font-family: Calibri;
        }
        .c3-axis-x-label {
            font-size: 14px;
            font-family: Calibri;
        }
        .c3-ygrid-line.threshold line{
        }
        .c3-ygrid-line.threshold text {
            font-size: 14px;
            font-family: Calibri;
        }
        .c3-xgrid-line.recommend line {
            stroke: #5cb85c;
            width: 20px;
        }
        .c3-xgrid-line.recommend text {
            font-size: 14px;
            font-family: Calibri;
            fill: #5cb85c;
            font-weight: bold;
        }
        body {
            font-size: 16px;
            font-family: Calibri;
            fill: #695a5a;
        }

    </style>
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
        #map {
            height: 400px;
            width: 100%;
        }
    </style>




    <div class="row" style="line-height:50px;"> 
        <div class="col-md-5">
            <h3 style="font-family:'Josefin Sans', sans-serif;" >Map with Airbnb location</h3>
        </div>
        <div class="col-md-6">
            <label style="font-family:'Josefin Sans', sans-serif;" >Date:</label>
            <input type="text" id="travel-daterange" name="daterange" class="form-control" style="display:inline;">
            <span id="canlendar-icon" class="glyphicon glyphicon-calendar"></span>
        </div>
    </div>

    <div class="row">
        <div class="col-md-5">
            <div class="row" style="padding-bottom: 5px;">
                <div class="col-md-2">
                    <label style="line-height: 30px">RoomType:</label>
                </div>
                <div class="col-md-4">
                    <select class="form-control" id="select-roomtype" style="max-width:100%;">
                        <option value="0">All</option>
                        <option value="1">Entire home/apt</option>
                        <option value="2">Private room</option>
                        <option value="3">Shared room</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label style="line-height: 30px">Neighbor:</label>
                </div>
                <div class="col-md-4">
                    <select class="form-control" id="select-neighbor" style="max-width:100%;">
                        <option>All</option>
                        <option>Lincoln Square</option>
                        <option>Hyde Park</option>
                        <option>Woodlawn</option>
                        <option>Rogers Park</option>
                        <option>Jefferson Park</option>
                        <option>Forest Glen</option>
                        <option>North Park</option>
                        <option>Albany Park</option>
                        <option>Dunning</option>
                        <option>West Ridge</option>
                        <option>Logan Square</option>
                        <option>West Town</option>
                        <option>Austin</option>
                        <option>Near West Side</option>
                        <option>Uptown</option>
                        <option>Near South Side</option>
                        <option>Norwood Park</option>
                        <option>Near North Side</option>
                        <option>Loop</option>
                        <option>South Shore</option>
                        <option>South Chicago</option>
                        <option>South Deering</option>
                        <option>West Pullman</option>
                        <option>Hegewisch</option>
                        <option>Garfield Ridge</option>
                        <option>Fuller Park</option>
                        <option>Lake View</option>
                        <option>Montclare</option>
                        <option>Clearing</option>
                        <option>Greater Grand Crossing</option>
                        <option>Lincoln Park</option>
                        <option>Ashburn</option>
                        <option>Mount Greenwood</option>
                        <option>Ohare</option>
                        <option>Edgewater</option>
                        <option>Douglas</option>
                        <option>Oakland</option>
                        <option>Grand Boulevard</option>
                        <option>Archer Heights</option>
                        <option>Kenwood</option>
                        <option>Washington Park</option>
                        <option>Portage Park</option>
                        <option>Irving Park</option>
                        <option>Belmont Cragin</option>
                        <option>Hermosa</option>
                        <option>Avondale</option>
                        <option>Humboldt Park</option>
                        <option>West Garfield Park</option>
                        <option>East Garfield Park</option>
                        <option>North Lawndale</option>
                        <option>South Lawndale</option>
                        <option>Lower West Side</option>
                        <option>Armour Square</option>
                        <option>Chatham</option>
                        <option>Calumet Heights</option>
                        <option>Roseland</option>
                        <option>North Center</option>
                        <option>Pullman</option>
                        <option>Brighton Park</option>
                        <option>Mckinley Park</option>
                        <option>Bridgeport</option>
                        <option>New City</option>
                        <option>West Elsdon</option>
                        <option>West Lawn</option>
                        <option>Chicago Lawn</option>
                        <option>West Englewood</option>
                        <option>Englewood</option>
                        <option>Auburn Gresham</option>
                        <option>Beverly</option>
                        <option>Washington Heights</option>
                        <option>Morgan Park</option>
                        <option>Edison Park</option>
                    </select>
                </div>
            </div>
            <div class="row">
                <div id="map"></div>
            </div>
        </div>
        <div class="col-md-7">
            <div class="row">
                <div class="alert alert-success">
                  
                <span class="glyphicon glyphicon-thumbs-up"></span>
                <strong>Recommended Date: </strong> 
                <span id="recommendedDate"></span>

                </div>
            </div>
            <div id="crime-line-chart"></div>
        </div>
    </div>

{% endblock %}

{% block scripts %}

    <!------------------------Script Start-------------------------->
    <!-- Main Startup-->
    <script>
        // Default Location
        var lat = 41.850033;
        var long = -87.6500523;
        var roomtype = 'All';
        var neighbor = 'All';
        window.onload = function () {
            updateChart();
            //initMap();
        };
        //// google map
        function initFusionMap() {
            
            var map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: lat, lng: long },
                zoom: 10
            });
            var filter = ""
            if (roomtype != 'All') {
                filter = "room_type='" + roomtype +"'";
            }

            if (neighbor != 'All') {
                if (filter != '')
                    filter += 'and ';
                filter += "neighbourhood='" + neighbor +"'";
            } 
            var layer = new google.maps.FusionTablesLayer({
                query: {
                    select: 'latitude',
                    from: '1i7WnQUcLkDOBrgMmmTKHIT1Qx8A3-li-JB3BG2Hh',
                    where: filter
                },
                styles: [
                    {
                        where: 'price_per_night <= 50',
                        markerOptions: {
                            iconName: "small_green"
                        }
                    },
                    {
                        where: 'price_per_night > 50 and price_per_night <= 100',
                        markerOptions: {
                            iconName: "small_yellow"
                        }
                    },
                    {
                        where: 'price_per_night > 100',
                        markerOptions: {
                            iconName: "small_red"
                        }
                    }

                ]

            });
            layer.setMap(map);


            google.maps.event.addListener(layer, 'click', function (e) {
                lat = e.row['latitude'].value;
                long = e.row['longitude'].value;
                locationName = e.row['name'].value;
                updateChart(locationName);
            });

        }
        
        //--- Initial Line Chart ----
        var chart = c3.generate({
            bindto: '#crime-line-chart',
            size: {
                height: 400
            },
                data: {
                    x: 'date',
                    //xFormat: '%Y-%m-%d',
                    json: [
                        { date: '2018-01-01', Person_Related: 0, Property_Related: 0,Drug_Related: 0, Weapon_Related: 0,Sexual_Exploitation: 0, Other_Offense: 0, Average: 0},
                        { date: '2018-01-02', Person_Related: 0, Property_Related: 0,Drug_Related: 0, Weapon_Related: 0,Sexual_Exploitation: 0, Other_Offense: 0, Average: 0},
                        { date: '2018-01-03', Person_Related: 0, Property_Related: 0,Drug_Related: 0, Weapon_Related: 0,Sexual_Exploitation: 0, Other_Offense: 0, Average: 0},
                        { date: '2018-01-04', Person_Related: 0, Property_Related: 0,Drug_Related: 0, Weapon_Related: 0,Sexual_Exploitation: 0, Other_Offense: 0, Average: 0},
                        { date: '2018-01-05', Person_Related: 0, Property_Related: 0,Drug_Related: 0, Weapon_Related: 0,Sexual_Exploitation: 0, Other_Offense: 0, Average: 0},
                        { date: '2018-01-06', Person_Related: 0, Property_Related: 0,Drug_Related: 0, Weapon_Related: 0,Sexual_Exploitation: 0, Other_Offense: 0, Average: 0},
                    ],
                    keys: {
                        x: 'date',
                        value: [ 'Person_Related', 'Property_Related', 'Drug_Related', 'Weapon_Related', 'Sexual_Exploitation', 'Other_Offense', 'Average']
                    }
                },
                axis: {
                    x: {
                        type: 'timeseries',
                        tick: {
                            format: '%d-%m-%Y'
                        },
                        label: {
                            text: '',
                            position: 'outer-center'
                            // inner-right : default
                            // inner-center
                            // inner-left
                            // outer-right
                            // outer-center
                            // outer-left
                        },
                    },
                    y: {
                        max: 100,
                        min: 100,
                        // Range includes padding, set 0 if no padding needed
                        padding: { top: 10, bottom: 10 },
                        label: {
                            text: 'Probability of Crime Occurance(%)',
                            position: 'outer-center'
                            // inner-right : default
                            // inner-center
                            // inner-left
                            // outer-right
                            // outer-center
                            // outer-left
                        }
                    }
                },
                zoom: {
                    enabled: true
                },
                color: {
                    pattern: ['#1f77b4', '#aec7e8', '#ff7f0e', '#ffbb78', '#2ca02c', '#98df8a', '#d62728', '#ff9896', '#9467bd', '#c5b0d5', '#8c564b', '#c49c94', '#e377c2', '#f7b6d2', '#7f7f7f', '#c7c7c7', '#bcbd22', '#dbdb8d', '#17becf', '#9edae5']
                }
        });
        
        //--- Setup daterange
        $(function () {
            $('input[name="daterange"]').daterangepicker(
                {
                    //"ranges": {
                    //    'Today': [moment(), moment()]
                    //},
                    "startDate": moment(),//moment().subtract(6, 'days'),
                    "endDate": moment().add(7, 'days'),
                    locale: {
                        format: 'DD/MM/YYYY'
                    },

                }
            );
        });
    </script>

    <!-- Call Python - Prediction API-->
    <script>

        var minDate;

        $(document).ready(function () {
            $('#travel-daterange').change(function () {
                updateChart();
            });
            $('#select-roomtype').change(function () {
                roomtype = $('#select-roomtype option:selected').text();
                initFusionMap();
            });
            $('#select-neighbor').change(function () {
                neighbor = $('#select-neighbor option:selected').text();
                console.log(neighbor);
                initFusionMap();
            });
            
            //$("#myClickButton").click(updateChart);
        });
        function clearChart() {
            // Update data
            chart.load({
                json: [
                    { date: '2018-01-01', Person_Related: 0, Property_Related: 0, Drug_Related: 0, Weapon_Related: 0, Sexual_Exploitation: 0, Other_Offense: 0, Average: 0 },
                    { date: '2018-01-02', Person_Related: 0, Property_Related: 0, Drug_Related: 0, Weapon_Related: 0, Sexual_Exploitation: 0, Other_Offense: 0, Average: 0 },
                    { date: '2018-01-03', Person_Related: 0, Property_Related: 0, Drug_Related: 0, Weapon_Related: 0, Sexual_Exploitation: 0, Other_Offense: 0, Average: 0 },
                    { date: '2018-01-04', Person_Related: 0, Property_Related: 0, Drug_Related: 0, Weapon_Related: 0, Sexual_Exploitation: 0, Other_Offense: 0, Average: 0 },
                    { date: '2018-01-05', Person_Related: 0, Property_Related: 0, Drug_Related: 0, Weapon_Related: 0, Sexual_Exploitation: 0, Other_Offense: 0, Average: 0 },
                    { date: '2018-01-06', Person_Related: 0, Property_Related: 0, Drug_Related: 0, Weapon_Related: 0, Sexual_Exploitation: 0, Other_Offense: 0, Average: 0 },
                ],
                keys: {
                    x: 'date',
                    value: ['Person_Related', 'Property_Related', 'Drug_Related', 'Weapon_Related', 'Sexual_Exploitation', 'Other_Offense', 'Average']
                }
            });
        }
        function updateChart(locationName='') {
            // Get Date from user input
            var selectedDateFrom = $('#travel-daterange').data('daterangepicker').startDate._d;
            var selectedDateTo = $('#travel-daterange').data('daterangepicker').endDate._d;

            // Formatting date for python api request 
            var DateFrom = selectedDateFrom.getFullYear() + "-" + (selectedDateFrom.getMonth() + 1) + "-" + selectedDateFrom.getDate();
            var DateTo = selectedDateTo.getFullYear() + "-" + (selectedDateTo.getMonth() + 1) + "-" + selectedDateTo.getDate();
        
            var reqDateFrom = selectedDateFrom.subtractDays(10);
            var reqDateTo = selectedDateTo.addDays(10);
            reqDateFrom = reqDateFrom.getFullYear() + "-" + (reqDateFrom.getMonth() + 1) + "-" + reqDateFrom.getDate();
            reqDateTo = reqDateTo.getFullYear() + "-" + (reqDateTo.getMonth() + 1) + "-" + reqDateTo.getDate();
            
            $.ajax({
                url: "/predict",
                type: "get", //HTTP method
            
                //**** Request Parameters
                data: { 
                    DateFrom: reqDateFrom, 
                    DateTo: reqDateTo, 
                    Lat: lat,
                    Long: long
                },

                //**** Response
                success: function(response) {
                    $("#myOutput").html(response);
                
                    // Update data
                    chart.load({
                        json: response,
                        keys: {
                            x: 'date',
                            value: [ 'Person_Related', 'Property_Related', 'Drug_Related', 'Weapon_Related', 'Sexual_Exploitation', 'Other_Offense', 'Average']
                        }
                    });
                    var min = 100;
                    response.forEach(function (element) {
                        if (element.Average < min) {
                            min = element.Average;
                            minDate = element.date;
                        }
                    });

                    chart.regions([{ axis: 'x', start: DateFrom, end: DateTo, class: 'regionX' }]);
                    chart.xgrids([
                      { value: minDate, text: 'RECOMMENDED DATE..LOWEST RISK', class: 'recommend'}
                    ]);

                    chart.ygrids([
                        { value: 50, text: 'THRESHOLD', class: 'threshold'}
                    ]);

                    document.getElementById("recommendedDate").innerHTML = minDate.toString();
                },
            
                //****Handle Error
                error: function(xhr) {
                //Do Something to handle error
                    console.log("error")
                    console.log(xhr)
                }
            });
     
        }

        Date.prototype.addDays = function (days) {
          var dat = new Date(this.valueOf());
          dat.setDate(dat.getDate() + days);
          return dat;
        }

        Date.prototype.subtractDays = function (days) {
          var dat = new Date(this.valueOf());
          dat.setDate(dat.getDate() - days);
          return dat;
        }
    </script>

    <script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
    <script async defer src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyDSMxi7rIRmoII_Bo_IoPmFyFtTfKASsr0&callback=initFusionMap"></script>

    <!------------------------Script End-------------------------->


    <!--src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDSMxi7rIRmoII_Bo_IoPmFyFtTfKASsr0">-->
{% endblock %}